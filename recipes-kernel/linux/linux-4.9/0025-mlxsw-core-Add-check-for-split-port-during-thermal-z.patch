From c81d0570b4a309bdf33d74db17dccc21b216e412 Mon Sep 17 00:00:00 2001
From: Vadim Pasternak <vadimp@mellanox.com>
Date: Tue, 26 Feb 2019 12:34:50 +0000
Subject: [PATCH backport 5.1] mlxsw: core: Add check for split port during
 thermal zone initialization

Skip thermal zone creation in case of split port.

Overwrite the first byte in base MAC address in
minimal driver.

Signed-off-by: Vadim Pasternak <vadimp@mellanox.com>
---
 drivers/net/ethernet/mellanox/mlxsw/core_thermal.c | 4 ++++
 drivers/net/ethernet/mellanox/mlxsw/minimal.c      | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/mellanox/mlxsw/core_thermal.c b/drivers/net/ethernet/mellanox/mlxsw/core_thermal.c
index 002654918ee9..3097228c2c29 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/core_thermal.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/core_thermal.c
@@ -751,6 +751,9 @@ mlxsw_thermal_module_init(struct device *dev, struct mlxsw_core *core,
 		return 0;
 
 	module = mlxsw_reg_pmlp_module_get(pmlp_pl, 0);
+	/* Skip if parent is already set - could in in case of port split. */
+	if (module_tz->parent)
+		return 0;
 	module_tz = &thermal->tz_module_arr[module];
 	module_tz->module = module;
 	module_tz->parent = thermal;
@@ -773,6 +776,7 @@ static void mlxsw_thermal_module_fini(struct mlxsw_thermal_module *module_tz)
 	if (module_tz && module_tz->tzdev) {
 		mlxsw_thermal_module_tz_fini(module_tz->tzdev);
 		module_tz->tzdev = NULL;
+		module_tz->parent = 0;
 	}
 }
 
diff --git a/drivers/net/ethernet/mellanox/mlxsw/minimal.c b/drivers/net/ethernet/mellanox/mlxsw/minimal.c
index 740b3753de44..cac36c231864 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/minimal.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/minimal.c
@@ -104,7 +104,7 @@ mlxsw_m_port_dev_addr_get(struct mlxsw_m_port *mlxsw_m_port)
 	 * to be such it does not overflow when adding local_port
 	 * value.
 	 */
-	dev->dev_addr[ETH_ALEN - 1] += mlxsw_m_port->module + 1;
+	dev->dev_addr[ETH_ALEN - 1] = mlxsw_m_port->module + 1;
 	return 0;
 }
 
-- 
2.11.0

