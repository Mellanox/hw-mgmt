From 027a136d82b09da7e8b0a3a64ca35acbb0ac3d13 Mon Sep 17 00:00:00 2001
From: Vadim Pasternak <vadimp@nvidia.com>
Date: Fri, 12 May 2023 06:28:18 +0000
Subject: [PATH backport 1/1] DBG: i2c: mlxcpld: COME BF3 debug

To be merged to previous two TMP patches.

Signed-off-by: Vadim Pasternak <vadimp@nvidia.com>
---
 drivers/i2c/busses/i2c-mlxcpld.c         |  20 ++--
 drivers/platform/mellanox/mlx-platform.c | 125 +++++++++++++++--------
 2 files changed, 87 insertions(+), 58 deletions(-)

diff --git a/drivers/i2c/busses/i2c-mlxcpld.c b/drivers/i2c/busses/i2c-mlxcpld.c
index 1e095c2ab..59708a1a1 100644
--- a/drivers/i2c/busses/i2c-mlxcpld.c
+++ b/drivers/i2c/busses/i2c-mlxcpld.c
@@ -53,8 +53,6 @@
 #define MLXCPLD_I2C_FREQ_400KHZ_SET	0x0e
 #define MLXCPLD_I2C_FREQ_100KHZ_SET	0x42
 
-#define MLXCPLD_I2C_PCI_IO_OFFSET	0x400
-
 enum mlxcpld_i2c_frequency {
 	MLXCPLD_I2C_FREQ_1000KHZ = 1,
 	MLXCPLD_I2C_FREQ_400KHZ = 2,
@@ -154,8 +152,8 @@ static void mlxcpld_i2c_lpc_write_buf_io(u8 *data, u8 len, void __iomem *addr)
 {
 	int i;
 
-	for (i = 0; i < len - len % 4; i += 4)
-		iowrite32(*(u32 *)(data + i), addr + i);
+	for (i = 0; i < len - len % 2; i += 2)
+		iowrite16(*(u16 *)(data + i), addr + i);
 	for (; i < len; ++i)
 		iowrite8(*(data + i), addr + i);
 }
@@ -164,8 +162,8 @@ static void mlxcpld_i2c_lpc_read_buf_io(u8 *data, u8 len, void __iomem *addr)
 {
 	int i;
 
-	for (i = 0; i < len - len % 4; i += 4)
-		*(u32 *)(data + i) = ioread32(addr + i);
+	for (i = 0; i < len - len % 2; i += 2)
+		*(u16 *)(data + i) = ioread16(addr + i);
 	for (; i < len; ++i)
 		*(data + i) = ioread8(addr + i);
 }
@@ -173,7 +171,7 @@ static void mlxcpld_i2c_lpc_read_buf_io(u8 *data, u8 len, void __iomem *addr)
 static void mlxcpld_i2c_read_comm_io(struct mlxcpld_i2c_priv *priv, u8 offs,
 				     u8 *data, u8 datalen)
 {
-	void __iomem *addr = priv->addr + MLXCPLD_I2C_PCI_IO_OFFSET + offs;
+	void __iomem *addr = priv->addr + offs;
 
 	switch (datalen) {
 	case 1:
@@ -186,9 +184,6 @@ static void mlxcpld_i2c_read_comm_io(struct mlxcpld_i2c_priv *priv, u8 offs,
 		*((u16 *)data) = ioread16(addr);
 		*(data + 2) = ioread8(addr + 2);
 		break;
-	case 4:
-		*((u32 *)data) = ioread32(addr);
-		break;
 	default:
 		mlxcpld_i2c_lpc_read_buf_io(data, datalen, addr);
 		break;
@@ -198,7 +193,7 @@ static void mlxcpld_i2c_read_comm_io(struct mlxcpld_i2c_priv *priv, u8 offs,
 static void mlxcpld_i2c_write_comm_io(struct mlxcpld_i2c_priv *priv, u8 offs,
 				      u8 *data, u8 datalen)
 {
-	void __iomem *addr = priv->addr + MLXCPLD_I2C_PCI_IO_OFFSET + offs;
+	void __iomem *addr = priv->addr + offs;
 
 	switch (datalen) {
 	case 1:
@@ -211,9 +206,6 @@ static void mlxcpld_i2c_write_comm_io(struct mlxcpld_i2c_priv *priv, u8 offs,
 		iowrite16(*((u16 *)data), addr);
 		iowrite8(*(data + 2), addr + 2);
 		break;
-	case 4:
-		iowrite32(*((u32 *)data), addr);
-		break;
 	default:
 		mlxcpld_i2c_lpc_write_buf_io(data, datalen, addr);
 		break;
diff --git a/drivers/platform/mellanox/mlx-platform.c b/drivers/platform/mellanox/mlx-platform.c
index d86168685..617f59a0a 100644
--- a/drivers/platform/mellanox/mlx-platform.c
+++ b/drivers/platform/mellanox/mlx-platform.c
@@ -334,20 +334,22 @@
 
 /* Lattice FPGA PCI configuration */
 #define PCI_VENDOR_ID_LATTICE			0x1204
-#define PCI_DEVICE_ID_LATTICE_LFD2NX40		0x9c1d
+#define PCI_DEVICE_ID_LATTICE_I2C_BRIDGE	0x9c2f
+#define PCI_DEVICE_ID_LATTICE_JTAG_BRIDGE	0x9c30
+#define PCI_DEVICE_ID_LATTICE_LPC_BRIDGE	0x9c32
 #define MLXPLAT_FPGA_PCI_BAR0_SIZE		0x4000
 #define MLXPLAT_FPGA_PCI_BASE_OFFSET		0x00000000
 #define MLXPLAT_FPGA_PCI_MSB_ADDR		0x25
 #define MLXPLAT_FPGA_PCI_LSB_ADDR_OFFSET	MLXPLAT_FPGA_PCI_BASE_OFFSET
 #define MLXPLAT_FPGA_PCI_MSB_ADDR_OFFSET	(MLXPLAT_FPGA_PCI_BASE_OFFSET + 0x01)
-#define MLXPLAT_FPGA_PCI_DATA_IN_OFFSET		(MLXPLAT_FPGA_PCI_BASE_OFFSET + 0x02)
-#define MLXPLAT_FPGA_PCI_DATA_OUT_OFFSET	(MLXPLAT_FPGA_PCI_BASE_OFFSET + 0x03)
+#define MLXPLAT_FPGA_PCI_DATA_OUT_OFFSET	(MLXPLAT_FPGA_PCI_BASE_OFFSET + 0x02)
+#define MLXPLAT_FPGA_PCI_DATA_IN_OFFSET		(MLXPLAT_FPGA_PCI_BASE_OFFSET + 0x03)
 #define MLXPLAT_FPGA_PCI_CTRL_OFFSET		(MLXPLAT_FPGA_PCI_BASE_OFFSET + 0x04)
 #define MLXPLAT_FPGA_PCI_STAT_OFFSET		(MLXPLAT_FPGA_PCI_BASE_OFFSET + 0x05)
 
 #define MLXPLAT_FPGA_PCI_CTRL_READ	BIT(0)
 #define MLXPLAT_FPGA_PCI_CTRL_WRITE	BIT(1)
-#define MLXPLAT_FPGA_PCI_COMPLETED	BIT(0)
+#define MLXPLAT_FPGA_PCI_COMPLETED	GENMASK(1, 0)
 #define MLXPLAT_FPGA_PCI_TO		50 /* usec */
 
 /* mlxplat_priv - platform private data
@@ -5897,6 +5899,7 @@ static int mlxplat_fpga_reg_read(void *context, unsigned int reg, unsigned int *
 		return err;
 
 	/* Set address in register space */
+
 	iowrite8(MLXPLAT_FPGA_PCI_MSB_ADDR, ctx->base + MLXPLAT_FPGA_PCI_MSB_ADDR_OFFSET);
 	iowrite8(reg, ctx->base + MLXPLAT_FPGA_PCI_LSB_ADDR_OFFSET);
 	/* Activate read operation */
@@ -5931,13 +5934,13 @@ static int mlxplat_fpga_reg_write(void *context, unsigned int reg, unsigned int
 	/* Activate write operation */
 	iowrite8(MLXPLAT_FPGA_PCI_CTRL_WRITE, ctx->base + MLXPLAT_FPGA_PCI_CTRL_OFFSET);
 
-	return 0;
+	return mlxplat_fpga_completion_wait(ctx);
 }
 
 static const struct regmap_config mlxplat_fpga_regmap_config_bf3_comex_default = {
-	.reg_bits = 16,
+	.reg_bits = 8,
 	.val_bits = 8,
-	.max_register = 512,
+	.max_register = 255,
 	.cache_type = REGCACHE_FLAT,
 	.writeable_reg = mlxplat_mlxcpld_writeable_reg,
 	.readable_reg = mlxplat_mlxcpld_readable_reg,
@@ -5966,7 +5969,10 @@ static struct mlxreg_core_platform_data
 	*mlxplat_wd_data[MLXPLAT_CPLD_WD_MAX_DEVS];
 static const struct regmap_config *mlxplat_regmap_config;
 static struct spi_board_info *mlxplat_spi;
-static struct pci_dev *fpga_dev;
+static struct pci_dev *lpc_bridge;
+static struct pci_dev *i2c_bridge;
+static struct pci_dev *jtag_bridge;
+void __iomem *i2c_bridge_addr, *jtag_bridge_addr;
 
 /* Platform default reset function */
 static int mlxplat_reboot_notifier(struct notifier_block *nb, unsigned long action, void *unused)
@@ -6635,12 +6641,6 @@ static int mlxplat_lpc_cpld_device_init(struct resource **hotplug_resources,
 {
 	int err;
 
-	mlxplat_dev = platform_device_register_simple(MLX_PLAT_DEVICE_NAME, PLATFORM_DEVID_NONE,
-						      mlxplat_lpc_resources,
-						      ARRAY_SIZE(mlxplat_lpc_resources));
-	if (IS_ERR(mlxplat_dev))
-		return PTR_ERR(mlxplat_dev);
-
 	mlxplat_mlxcpld_regmap_ctx.base = devm_ioport_map(&mlxplat_dev->dev,
 							  mlxplat_lpc_resources[1].start, 1);
 	if (!mlxplat_mlxcpld_regmap_ctx.base) {
@@ -6664,13 +6664,14 @@ static void mlxplat_lpc_cpld_device_exit(void)
 }
 
 static int
-mlxplat_pci_fpga_device_init(struct resource **hotplug_resources,
-			     unsigned int *hotplug_resources_size, struct pci_dev **fpga_dev)
+mlxplat_pci_fpga_device_init(unsigned int device, const char *res_name, struct pci_dev **pci_bridge,
+			     void __iomem **pci_bridge_addr)
 {
+	void __iomem *pci_mem_addr;
 	struct pci_dev *pci_dev;
 	int err;
 
-	pci_dev = pci_get_device(PCI_VENDOR_ID_LATTICE, PCI_DEVICE_ID_LATTICE_LFD2NX40, NULL);
+	pci_dev = pci_get_device(PCI_VENDOR_ID_LATTICE, device, NULL);
 	if (!pci_dev)
 		return -ENODEV;
 
@@ -6680,7 +6681,7 @@ mlxplat_pci_fpga_device_init(struct resource **hotplug_resources,
 		goto fail_pci_enable_device;
 	}
 
-	err = pci_request_region(pci_dev, 0, "mlxplat_fpga");
+	err = pci_request_region(pci_dev, 0, res_name);
 	if (err) {
 		dev_err(&pci_dev->dev, "pci_request_regions failed with error %d\n", err);
 		goto fail_pci_request_regions;
@@ -6695,31 +6696,22 @@ mlxplat_pci_fpga_device_init(struct resource **hotplug_resources,
 		}
 	}
 
-	if (pci_resource_len(pci_dev, 0) < MLXPLAT_FPGA_PCI_BAR0_SIZE) {
-		dev_err(&mlxplat_dev->dev, "invalid PCI region size\n");
-		err = -EINVAL;
-		goto fail_pci_resource_len_check;
-	}
+	pci_set_master(pci_dev);
 
-	mlxplat_mlxcpld_regmap_ctx.base = devm_ioremap(&pci_dev->dev,
-						       pci_resource_start(pci_dev, 0),
-						       pci_resource_len(pci_dev, 0));
-	if (!mlxplat_mlxcpld_regmap_ctx.base) {
+	pci_mem_addr = devm_ioremap(&pci_dev->dev, pci_resource_start(pci_dev, 0),
+				    pci_resource_len(pci_dev, 0));
+	if (!pci_mem_addr) {
 		dev_err(&mlxplat_dev->dev, "ioremap failed\n");
 		err = -EIO;
 		goto fail_ioremap;
 	}
 
-	pci_set_master(pci_dev);
-
-	*hotplug_resources = mlxplat_mlxfpga_resources;
-	*hotplug_resources_size = ARRAY_SIZE(mlxplat_mlxfpga_resources);
-	*fpga_dev = pci_dev;
+	*pci_bridge = pci_dev;
+	*pci_bridge_addr = pci_mem_addr;
 
 	return 0;
 
 fail_ioremap:
-fail_pci_resource_len_check:
 fail_pci_set_dma_mask:
 	pci_release_regions(pci_dev);
 fail_pci_request_regions:
@@ -6728,12 +6720,58 @@ mlxplat_pci_fpga_device_init(struct resource **hotplug_resources,
 	return err;
 }
 
-static void mlxplat_pci_fpga_device_exit(void)
+static void
+mlxplat_pci_fpga_device_exit(struct pci_dev *pci_bridge,
+			     void __iomem *pci_bridge_addr)
 {
-	platform_device_unregister(mlxplat_dev);
-	iounmap(mlxplat_mlxcpld_regmap_ctx.base);
-	pci_release_regions(fpga_dev);
-	pci_disable_device(fpga_dev);
+	iounmap(pci_bridge_addr);
+	pci_release_regions(pci_bridge);
+	pci_disable_device(pci_bridge);
+}
+\
+
+static int
+mlxplat_pci_fpga_devices_init(struct resource **hotplug_resources,
+			      unsigned int *hotplug_resources_size)
+{
+	int err;
+
+	err = mlxplat_pci_fpga_device_init(PCI_DEVICE_ID_LATTICE_LPC_BRIDGE,
+					   "mlxplat_lpc_bridge", &lpc_bridge,
+					   &mlxplat_mlxcpld_regmap_ctx.base);
+	if (err)
+		goto mlxplat_pci_fpga_device_init_lpc_fail;
+
+	err = mlxplat_pci_fpga_device_init(PCI_DEVICE_ID_LATTICE_I2C_BRIDGE,
+					   "mlxplat_i2c_bridge", &i2c_bridge,
+					    &i2c_bridge_addr);
+	if (err)
+		goto mlxplat_pci_fpga_device_init_i2c_fail;
+
+	err = mlxplat_pci_fpga_device_init(PCI_DEVICE_ID_LATTICE_JTAG_BRIDGE,
+					   "mlxplat_jtag_bridge", &jtag_bridge,
+					    &jtag_bridge_addr);
+	if (err)
+		goto mlxplat_pci_fpga_device_init_jtag_fail;
+
+	*hotplug_resources = mlxplat_mlxfpga_resources;
+	*hotplug_resources_size = ARRAY_SIZE(mlxplat_mlxfpga_resources);
+
+	return 0;
+
+mlxplat_pci_fpga_device_init_jtag_fail:
+	mlxplat_pci_fpga_device_exit(i2c_bridge, i2c_bridge_addr);
+mlxplat_pci_fpga_device_init_i2c_fail:
+	mlxplat_pci_fpga_device_exit(lpc_bridge, mlxplat_mlxcpld_regmap_ctx.base);
+mlxplat_pci_fpga_device_init_lpc_fail:
+	return err;
+}
+
+static void mlxplat_pci_fpga_devices_exit(void)
+{
+	mlxplat_pci_fpga_device_exit(jtag_bridge, jtag_bridge_addr);
+	mlxplat_pci_fpga_device_exit(i2c_bridge, i2c_bridge_addr);
+	mlxplat_pci_fpga_device_exit(lpc_bridge, mlxplat_mlxcpld_regmap_ctx.base);
 }
 
 static int
@@ -6741,7 +6779,7 @@ mlxplat_pre_init(struct resource **hotplug_resources, unsigned int *hotplug_reso
 {
 	int err;
 
-	err = mlxplat_pci_fpga_device_init(hotplug_resources, hotplug_resources_size, &fpga_dev);
+	err = mlxplat_pci_fpga_devices_init(hotplug_resources, hotplug_resources_size);
 	if (err == -ENODEV)
 		return mlxplat_lpc_cpld_device_init(hotplug_resources, hotplug_resources_size);
 
@@ -6750,8 +6788,8 @@ mlxplat_pre_init(struct resource **hotplug_resources, unsigned int *hotplug_reso
 
 static void mlxplat_post_exit(void)
 {
-	if (fpga_dev)
-		mlxplat_pci_fpga_device_exit();
+	if (lpc_bridge)
+		mlxplat_pci_fpga_devices_exit();
 	else
 		mlxplat_lpc_cpld_device_exit();
 }
@@ -6982,8 +7020,8 @@ static int mlxplat_i2c_main_init(struct mlxplat_priv *priv)
 	mlxplat_i2c->handle = priv;
 
 	/* Set mapped base address of I2C-LPC bridge over PCIe */
-	if (fpga_dev)
-		mlxplat_i2c->addr = mlxplat_mlxcpld_regmap_ctx.base;
+	if (lpc_bridge)
+		mlxplat_i2c->addr = i2c_bridge_addr;
 	priv->pdev_i2c = platform_device_register_resndata(&mlxplat_dev->dev, "i2c_mlxcpld",
 							   nr, priv->hotplug_resources,
 							   priv->hotplug_resources_size,
@@ -7047,7 +7085,6 @@ static int mlxplat_probe(struct platform_device *pdev)
 
 	if (!mlxplat_regmap_config)
 		mlxplat_regmap_config = &mlxplat_mlxcpld_regmap_config;
-
 	priv->regmap = devm_regmap_init(&mlxplat_dev->dev, NULL,
 					&mlxplat_mlxcpld_regmap_ctx,
 					mlxplat_regmap_config);
-- 
2.20.1

